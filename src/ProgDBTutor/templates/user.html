<html>
<head>
    <meta charset="UTF-8">
    <title>Recommended4you - Usersection</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style/user_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style/home_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style/style.css') }}">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="{{ url_for('static',filename='jquery-3.2.1.js') }}"></script>
</head>
<body>
{#Navbar section#}
    <nav class="navbar" id="navbar">
        <div class="navbar_container">
            <div class="navbar_toggle" id="mobile-menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
            <ul class="navbar_menu">
                <li class="navbar_items"><a class="navbar_links" id="home-page" href="home">Home</a></li>
                <li class="navbar_items"><a class="navbar_links" id="services-page" href="services">A/B-test</a></li>
                <li class="navbar_items"><a class="navbar_links" id="datasets-page" href="datasets">Datasets</a></li>
                <li class="navbar_items"><a class="navbar_links" id="visualizations-page" href="visualizations">Visualizations</a></li>
                <li class="navbar_items"><a class="navbar_links" id="testlist-page" href="testlist">Testlist</a></li>
            </ul>
        </div>
    </nav>

    <div class="container__usersection">

        <!--        info-->
        <div class="container__info">
           <div class="container__header_attributes">
                <h2>DATASET: {{ datasetname }}</h2>
            </div>
<!--            username-->
            <div class="container__header_attributes">
                <h2>CUSTOMER ID: {{ username }}</h2>
            </div>
            <div class="container__info_his_grp">
                <main class="container__info_history">
                    <section id="innerHistory">
                        LOADING USER HISTORY...
                    </section>
                </main>
                <div class="container__info_graph">

                    <div class="container__graph">
                        <div class="graph" id="purchasesGraph">
                            LOADING GRAPH...
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <main class="container__info_topk">
                    <section id="innerAlgorithm">
                        LOADING ALGORITHMS...
                    </section>
                </main>

            <div class="intervalPicker">
                <div class="arrowLeft" onclick="update(-1)"></div>
                <div class="counter">
                    <section id="counterInterval">LOADING INTERVAL...</section>
                </div>
                <div class="arrowRight" onclick="update(1)"></div>
            </div>
            </div>

        </div>
    </div>
</body>

<script>

    var interval = null;
    var value = 0;
    var recommendations = null;
    var history_ = null;
    var graph = null;
    var ABinterval = null;
    var maxValue = 0;
    var top_kList = null;

    function fetchStatus() {

        fetch(`/usersection/update`)
            .then(function (response) {
                return response.text();
            })
            .then(function (info) {
                var returnDict = JSON.parse(info)
                if (Object.keys(returnDict).length > 0) {
                    recommendations = JSON.parse(returnDict["recommendations"])
                    history_ = JSON.parse(returnDict["history"])
                    graph = JSON.parse(returnDict["graph"])
                    ABinterval = returnDict["interval"]
                    maxValue = recommendations.length;
                    top_kList = JSON.parse(returnDict["topkListprint"])
                    clearInterval(interval)
                    update(0)
                }

            })
    }
    window.addEventListener('load', function () {
        let fetchInterval = 1000;
        interval = setInterval(fetchStatus, fetchInterval)
    })

    function update(number){
        value = value + number;
        if (value < 0){
            value = 0;
        }
        else if (value > maxValue - 1){
            value = maxValue - 1;
        }

        {#console.log(recommendations)#}
        document.getElementById("counterInterval").innerHTML = (value+1).toString() + " / " + (recommendations.length).toString()
        generateAlgoritmes(value);
        generateHistory(value);
        google.charts.load('current', {'packages':['corechart','bar']});
        google.setOnLoadCallback(function () {
            makeGraph(value);
        });
    }

    function generateAlgoritmes(value_){
        var algos = document.getElementById("innerAlgorithm")
        var counter = 0;
        var html_ = ""
        document.getElementById("counterInterval").innerHTML += "    â€”    " + recommendations[value_][0]["date"]
        let ticks_ = [0];
        let calcBools = false;

        for (const reco of recommendations[value_]){
            {#console.log(reco["name"], reco["date"], reco["recommendations"], reco["color"]);#}
            html_ += "<div class=\"st_wrap_table\" data-table_id=\" + counter.toString() + \">";
            html_ +=     "<header class=\"topk_table_header\">";
            html_ +=         "<h2>Algorithm: " + reco["name"] + "</h2>";
            html_ +=         "<div class=\"topk_row\">";
            html_ +=             "<div class=\"topk_column_header\"> Algorithm number: " + reco["result_id"] + " </div>";
            html_ +=         "</div>";
            html_ +=     "</header>";
            html_ +=     "<div class=\"topk_table\" style=\"background-color: " + reco["color"] + "\">";

            let count = 0;
            console.log(reco)
            for (const item of reco["recommendations"]){

                if (count == 0){
                    html_ +=     "<div class=\"topk_table_rows\">";
                }
                html_ +=     "<div class=\"topk_column_item\">" + item + " </div>";
                count += 1

                if (count == 3) {
                    count = 0
                    html_ +=     "</div>";
                }
            }
            html_ += "</div>"
            calcBools = true;
            counter += 1;
            html_ += "</div>";
        }

        algos.innerHTML = html_;

    }

    function generateHistory(value_){
        var history = document.getElementById("innerHistory")
        var html_ = ""

        html_ += "<div class=\"st_wrap_table\" >"
        html_ +=     "<header class=\"history_table_header\">"
        html_ +=         "<h2>Purchases of the user</h2>"
        html_ +=         "<div class=\"history_row\">"
        html_ +=            "<div class=\"history_column_header\">" + ABinterval + "</div>"
        html_ +=         "</div>"
        html_ +=         "</header>"
        html_ +=         "<div class=\"history_table\">"
        html_ +=             "<div id=\"history_table_items\" class=\"history_table_items\">"

        for (const item of history_[value_]){


            html_ +=             "<div id=\""+ item["item"] +"\" class=\"history_table_rows\">";
            html_ +=                 "<div onclick='generateImage(\"" + item["url"] + "\")'  class=\"history_column_item\">" + item["item"] + "</div>";
            if (item["purchased"]){
                html_ +=             "<div class=\"history_column_hasImage\" style=\"color: #91ee05\">&#9745</div>";
            }
            else {
                html_ +=             "<div class=\"history_column_hasImage\" style=\"color: #b90000\">&#9746</div>";
            }
            html_ +=             "</div>";
        }
        html_ +=         "</div>";
        html_ +=         "<div class=\"history_table_image\">";
        html_ +=             "<section id=innerUrl ></section>";
        html_ +=         "</div>";
        html_ +=     "</div>";
        html_ += "</div>";
        history.innerHTML = html_
    }

    function generateImage(itemURL){

        innerImg = document.getElementById("innerUrl")
        if (itemURL == ""){
            innerImg.innerHTML = "No image"
        }
        else {
            html_ = "<img src=";
            html_ += itemURL;
            html_ += " alt=\"Image\" style='height: 100%; width: 100%; object-fit: contain'>";
            innerImg.innerHTML =  html_;
        }

    }

    function makeGraph(value_, ticks_){
        document.getElementById("purchasesGraph").innerHTML = ""
        var data_ = [['Algorithm', 'Bought', {role: 'style'}]]
        for (const row of graph[value_]) {
            data_.push(row);

        }
        console.log(data_)
        var dataitems = new google.visualization.arrayToDataTable(data_);

        var options = {
          title: "Number of purchases per recommendation",
          chartArea: {
              width: '85%'
          },
          legend: { position: 'none' },
          chart: {
            title: "Number of purchases per recommendation"
          },
          hAxis: {
              title: 'Algorithms'
            },
          vAxis: {
            title: 'Items bought',
            ticks: top_kList
          },
          bar: { groupWidth: "100%" }
        };

        {#var chart = new google.charts.Bar(document.getElementById("purchasesGraph"));#}
        {#// Convert the Classic options to Material options.#}
        {#chart.draw(dataitems, google.charts.Bar.convertOptions(options));#}

        var chart = new google.visualization.ColumnChart(document.getElementById('purchasesGraph'));
        chart.draw(dataitems, options);
    }

</script>

</html>