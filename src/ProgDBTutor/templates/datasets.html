<html>
<head>

    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

	<link rel="stylesheet" href="{{ url_for('static',filename='bootstrap-4.0.0.min.css') }}">
	<link rel="stylesheet" href="{{ url_for('static',filename='style/style.css') }}">
	<link rel="stylesheet" href="{{ url_for('static',filename='style/home_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style/datasets_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style/sharedStyle.css') }}">

	<script src="{{ url_for('static',filename='jquery-3.2.1.js') }}"></script>
	<script src="{{ url_for('static',filename='bootstrap-4.0.0.min.js') }}"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<style>
    html, body {
        background-color: #E3E9F0;
    }
</style>

<body>

<nav class="navbar" id="navbar">
    <div class="navbar_container">
        <div class="navbar_toggle" id="mobile-menu">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>
        <ul class="navbar_menu">
            <li class="navbar_items"><a class="navbar_links" id="home-page" href="home">Home</a></li>
            <li class="navbar_items"><a class="navbar_links" id="services-page" href="services">A/B-test</a></li>
            <li class="navbar_items"><a class="navbar_links" id="datasets-page" href="datasets">Datasets</a></li>
            <li class="navbar_items"><a class="navbar_links" id="visualizations-page" href="visualizations">Visualizations</a></li>
            <li class="navbar_items"><a class="navbar_links" id="testlist-page" href="testlist">Testlist</a></li>
        </ul>
    </div>
</nav>

<div class="giantcontainer">

    <form method="GET" action="" name="form1" id="form1">
    <div class="_container0" id="_container0" style="display: block;">
        <div class="_row">
            <div class="_column">
                <select class="c0_select" id="datasetSelection" name="datasetSelection" onchange="sendData();goToABTestPage();">
                    {% for id, name in names %}
                        <option value="{{ id }}">dataset: {{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="_column">
                <button class="c0_button" role="button" id="add_btn" name="add_btn" onclick="toggleDatasetView();">
                    Add dataset
                </button>
            </div>

        </div>
{#    </div>#}

{#    <div class="_container1" id="_container1" style="display: block;">#}
        <div class="_row">
            <div class="_column">
                <div class="c1_statcontainer" style="margin-left: 50px;">
                    <h2>Number of customers:</h2>
                    <p id="nr_of_customers">0</p>
                </div>
            </div>
            <div class="_column">
                <div class="c1_statcontainer">
                    <h2>Number of items:</h2>
                    <p id="nr_of_items">0</p>
                </div>
            </div>
            <div class="_column">
                <div class="c1_statcontainer" style="margin-right: 50px;">
                    <h2>Number of interactions:</h2>
                    <p id="nr_of_interactions">0</p>
                </div>
            </div>
        </div>
        <div class="_row" id="dashboard_div">
            <div class="_column">
                <div class="c1_graphcontainer"  style="margin-left: 50px;" id="graph-active">

                </div>

            </div>
            <div class="_column">
                <div class="c1_graphcontainer"   id="graph-distr">

                </div>
            </div>
            <div class="_column">
                <div class="c1_graphcontainer" style="margin-right: 50px;" id="graph-ts">

                </div>
            </div>
        </div>
{#    </div>#}

{#    <div class="_container2" id="_container2" style="display: block;">#}
        <div class="_row">
            <div class="_column">
                <button class="c2_button_" style="margin-left: 50px;" role="button" id="abtestpagelink" name="abtestpagelink" >
                    <a class="abtestlink" id="abtestlink" href="services"> Go to A/B-test page with this dataset </a>
                </button>
            </div>
            <div class="_column">
                <button class="c2_button_" style="margin-right: 50px;" type="submit" role="button" id="delete_btn" name="delete_btn">
                    Delete dataset
                </button>
            </div>
        </div>
    </div>
    </form>
    <div class="_container3" id="_container3" style="display: none;">
        <form id="upload-files" method="POST" action="" enctype="multipart/form-data" name="form2">
            <div class="_row">
                <div class="_column">
                    <div class="c3_namecontainer" style="margin-left: 50px;margin-right: 50px">
                        <input type="text" id="ds_name" name="ds_name" placeholder="Enter dataset name" required>
                    </div>
                </div>
            </div>

            <div class="_row">

                <div class="_column">
                    <div class="c3_filecontainer" style="margin-left: 50px;">
                        <h2> Articles file</h2>
                        <div id="btn1" onclick="getFile1()"> Choose file </div>
                        <div style="height: 0px; width: 0px; overflow: hidden;">
                            <input type="file" id="articles_file" name="articles_file" value="" accept=".csv" required onchange="sub1(this);">
                        </div>
                        <div class="typeformcontainer" id="typeformcontainer1">
                            <section id="articles_attr_section">
                            </section>
                        </div>
                        <div class="choosenamecontainer">
                            <h4> Column that should serve as name:</h4>
                            <section id="articles_cname_section">
                            </section>
                        </div>
                    </div>
                </div>

                <div class="_column">
                    <div class="c3_filecontainer">
                        <h2> Purchases file</h2>
                        <div id="btn2" onclick="getFile2()"> Choose file </div>
                        <div style="height: 0px; width: 0px; overflow: hidden;">
                            <input type="file" id="purchases_file" name="purchases_file" value="" accept=".csv" required onchange="sub2(this)">
                        </div>
                    </div>
                </div>

                <div class="_column">
                    <div class="c3_filecontainer" style="margin-right: 50px;">
                        <h2> Customers file</h2>
                        <div id="btn3" onclick="getFile3()"> Choose file </div>
                        <div style="height: 0px; width: 0px; overflow: hidden;">
                            <input type="file" id="customers_file" name="customers_file" value="" accept=".csv" required onchange="sub3(this)">
                        </div>
                        <div class="typeformcontainer" id="typeformcontainer2">
                            <section id="customers_attr_section">
                            </section>
                        </div>
                        <div class="choosenamecontainer">
                            <h4> Column that should serve as name:</h4>
                            <section id="customers_cname_section">
                            </section>
                        </div>
                    </div>
                </div>
            </div>

            <div class="_row">
                <div class="_column">
                    <div class="c3_button" style="margin-left: 50px">
                        <button type="submit" role="button">
                            Add dataset
                        </button>
                    </div>
                </div>
                <div class="_column">
                    <div class="c3_button" style="margin-right: 50px">
                        <button type="submit" role="button" onclick="toggleDatasetView()">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

</div>


<script>
    {#var row_id = 0;#}
window.onload = sendData();goToABTestPage();

{#var fileAttributes = {'articles': [], 'customers': []};#}
{#var article_attr = ["aa", "ab", "ac", "ad", "ae", "af", "ag0bvb", "ah"];#}
{#var customer_attr = ["ca", "cb", "cc", "cd"];#}
{#fileAttributes['articles'] = article_attr;#}
{#fileAttributes['customers'] = customer_attr;#}

function goToABTestPage() {
    var ds = document.getElementById("datasetSelection");
    ds = ds.value;
    console.log(ds);
    var link = document.getElementById('abtestlink');
    link.href += '?selected_ds_id=' + ds;
}

$(function() {
    $('#articles_file, #customers_file').change(function() {
        var form_data = new FormData($('#upload-files')[0]);
        console.log(form_data);
        $.ajax({
            type: 'POST',
            url: '/fileupload',
            data: form_data,
            contentType: false,
            cache: false,
            processData: false,
            success: function(data) {
                console.log("Successfully loaded file arguments!");
                console.log(data['articles_attr']);
                console.log(data['customers_attr']);
                generateAttrHtml(data);

            },
        });
    });
});

var attr_types = JSON.parse({{ attr_types | tojson | safe }});

function generateAttrHtml(data) {
    if (data['changed'] === 'articles_attr') {
        var attrElem = document.getElementById("articles_attr_section");
        var _html = "";
        var articles_attr_list = data['articles_attr'];
        var art_select_id = 0;
        for (var attribute of articles_attr_list) {
            _html += "<div class=\"row\">";
            _html += "<div class=\"col-25\" style=\"width: 60%; text-align: left;font-size: 10px;\"><label for=\"" + attribute + "\">" + attribute + "</label></div>";
            _html += "<div class=\"col-75\" style=\"width: 40%\">";
            _html += "<select class=\"\" id=\"" + art_select_id + "\" name=\"" + art_select_id + "\">";
            console.log(attr_types);
            for (var _type of attr_types) {
                _html += "<option value=\"" + _type + "\">" + _type + "</option>\n";
            }
            _html += "</select>";
            _html += "</div>";
            _html += "</div>";
            art_select_id++;
        }

        attrElem.innerHTML = _html;

        var attrNameElem = document.getElementById("articles_cname_section");
        _html = "";
        _html += "<select class=\"\" id=\"articles_name_column\" name=\"articles_name_column\">";
        for (var attribute1 of articles_attr_list) {
            _html += "<option value=\"" + attribute1 + "\">" + attribute1 + "</option>";
        }
        _html += "</select>";
        attrNameElem.innerHTML = _html;
    }
    else {
        attrElem = document.getElementById("customers_attr_section");
        _html = "";
        articles_attr_list = data['customers_attr'];
        var cust_select_id = -1;

        for (var attribute2 of articles_attr_list) {
            _html += "<div class=\"row\">";
            _html += "<div class=\"col-25\" style=\"width: 60%; text-align: left;font-size: 10px;\"><label for=\"" + attribute2 + "\">" + attribute2 + "</label></div>";
            _html += "<div class=\"col-75\" style=\"width: 40%\">";
            _html += "<select class=\"\" id=\"" + cust_select_id + "\" name=\"" + cust_select_id + "\">";
            console.log(attr_types);
            for (var __type of attr_types) {
                _html += "<option value=\"" + __type + "\">" + __type + "</option>\n";
            }
            _html += "</select>";
            _html += "</div>";
            _html += "</div>";
            cust_select_id--;
        }

        attrElem.innerHTML = _html;

        attrNameElem = document.getElementById("customers_cname_section");
        _html = "";
        _html += "<select class=\"\" id=\"customers_name_column\" name=\"customers_name_column\">";
        for (var attribute3 of articles_attr_list) {
            _html += "<option value=\"" + attribute3 + "\">" + attribute3 + "</option>";
        }
        _html += "</select>";
        attrNameElem.innerHTML = _html;
    }
}

function getFile1() {
    document.getElementById("articles_file").click();
}
function getFile2() {
    document.getElementById("purchases_file").click();
}
function getFile3() {
    document.getElementById("customers_file").click();
}

function sub1(obj) {
    var file = obj.value;
    var filename = file.split("\\");
    document.getElementById("btn1").innerHTML = filename[filename.length - 1];
    event.preventDefault();
}

function sub2(obj) {
    var file = obj.value;
    var filename = file.split("\\");
    document.getElementById("btn2").innerHTML = filename[filename.length - 1];
    event.preventDefault();
}

function sub3(obj) {
    var file = obj.value;
    var filename = file.split("\\");
    document.getElementById("btn3").innerHTML = filename[filename.length - 1];
    event.preventDefault();
}

var interval = null;
function fetchStatusHere() {
    let id = document.getElementById("datasetSelection");
    if(id.options.length){
        id = document.getElementById("datasetSelection").value;
    }else{
        id = -1;
    }
    fetch(`/datasets/update/${id}`)
        .then(function (response) {
                return response.text();
            })
        .then(function (text){
            if (text === 'done'){
                sendData()
                clearInterval(interval)
            }else if (text === 'no refresh'){
                clearInterval(interval)
            }
        })
}


window.addEventListener('load', function () {
    let fetchInterval = 5000;
    interval = setInterval(fetchStatusHere, fetchInterval)
})

function sendData() {
    let id = document.getElementById("datasetSelection").value;

    fetch(`/datasets/${id}`).then(function(response) {
        return response.text();
    }).then(function(text) {
        console.log(text)
        var statistics = JSON.parse(text)
        console.log()
        document.getElementById("nr_of_customers").innerHTML = statistics[0].users
        document.getElementById("nr_of_items").innerHTML = statistics[0].articles
        document.getElementById("nr_of_interactions").innerHTML = statistics[0].interactions

        var dataDist = [["price range", "number of items"]]
        for (i=0; i < statistics[0].distributions.length; i++){
            var begin = statistics[0].distributions[i].begin
            var end = statistics[0].distributions[i].end
            var priceCount = statistics[0].distributions[i].count
            dataDist.push([begin.toString() + "-" + end.toString(), priceCount])
        }

        var dataUsers = [["date", "number of active users"]]
        for (i=0; i < statistics[0].activeUsers.length; i++){
            var dateS = statistics[0].activeUsers[i].date
            var userCount = statistics[0].activeUsers[i].count

            dataUsers.push([dateS, userCount])
        }

        var dataInteractions = [["date", "number of interactions"]]
        for (i=0; i < statistics[0].interactionPerMonth.length; i++){
            var dateS = statistics[0].interactionPerMonth[i].date
            var interactionCount = statistics[0].interactionPerMonth[i].count

            dataInteractions.push([dateS, interactionCount])
        }

        google.charts.load('current', {'packages':['bar']});
        google.setOnLoadCallback(function () {
            drawGraph(dataUsers, "graph-active", "Number of active users")
            drawGraph(dataDist, "graph-distr", "Price distribution")
            drawGraph(dataInteractions, "graph-ts", "Number of interactions")
        });
    });
}

function drawGraph(data, name, title_){
        console.log(data)
        var dataitems = new google.visualization.arrayToDataTable(data);

        var options = {
          chartArea: {
              width: '94%'
          },
          legend: { position: 'none' },
          chart: {
            title: title_},
          axes: {
            x: {
              0: { side: 'top'} // Top x-axis.
            }
          },
          bar: { groupWidth: "100%" }
        };

        var chart = new google.charts.Bar(document.getElementById(name));
        // Convert the Classic options to Material options.
        chart.draw(dataitems, google.charts.Bar.convertOptions(options));
}

{#function displayC3() {#}
{#    var c3 = document.getElementById("_container3");#}
{#    if (c3.style.display == "none") {#}
{#        c3.style.display = "block";#}
{#    }#}
{#    else {#}
{#        c3.style.display = "none";#}
{#    }#}
{##}

function toggleDatasetView() {
    var c0 = document.getElementById("_container0");
    var c3 = document.getElementById("_container3");
    if (c0.style.display === "none") {
        c0.style.display = "block";
        c3.style.display = "none";
    }
    else {
        c0.style.display = "none";
        c3.style.display = "block";
    }
    event.preventDefault();
}

$('button.c0_button').click(function(e) {
    e.preventDefault();
});

{#function selectRow() {#}
{#    row_id = event.target.id;#}

{##}
{#function sendTableData() {#}
{#    var data = document.getElementById(row_id).querySelectorAll(".row_data");#}
{#    var id = data[0].innerHTML;#}
{#    var name = data[1].innerHTML;#}
{#    #}

</script>

</body>
</html>




