<html>
<head>

    <title>Recommended4you - Visualisation</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style/user_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style/home_style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='style/visualizations_style.css') }}">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="{{ url_for('static',filename='jquery-3.2.1.js') }}"></script>


    <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
    <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="https://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>


</head>
<body>

{#Navbar section#}
<nav class="navbar" id="navbar">
    <div class="navbar_container">
        <div class="navbar_toggle" id="mobile-menu">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>
        <ul class="navbar_menu">
            <li class="navbar_items"><a class="navbar_links" id="home-page" href="home">Home</a></li>
            <li class="navbar_items"><a class="navbar_links" id="services-page" href="services">A/B-test</a></li>
            <li class="navbar_items"><a class="navbar_links" id="datasets-page" href="datasets">Datasets</a></li>
            <li class="navbar_items"><a class="navbar_links" id="visualizations-page" href="visualizations">Visualizations</a></li>
            <li class="navbar_items"><a class="navbar_links" id="testlist-page" href="testlist">Testlist</a></li>
        </ul>
    </div>
</nav>

<div class="container__itemsection">

{#    AB-InfoSection#}
    <div class="container__info">
        <div class="split__container">
            <div class="ab_container__info">
                <div class="ab__split">
                    <div class="ab__info">
                        <p>AB-test ID:</p>
                        <p id="abtest_id"></p>
                    </div>
                    <div class="ab__info">
                        <p>Dataset name:</p>
                        <p id="dataset_name"></p>
                    </div>
                    <div class="ab__info">
                        <p>Startpoint:</p>
                        <p id="startpoint"></p>
                    </div>
                </div>
                <div class="ab__split">
                    <div class="ab__info">
                        <p>Stepsize:</p>
                        <p id="stepsize"></p>
                    </div>
                    <div class="ab__info">
                        <p>Top-k:</p>
                        <p id="topk"></p>
                    </div>
                    <div class="ab__info">
                        <p>Endpoint:</p>
                        <p id="endpoint"></p>
                    </div>
                </div>
            </div>
            <div class="ab_container__table" id="algorithmTable">
                <table class="generalPurpose_table flex-fixhead-algorithm_table" id="test1">
                    <thead>
                    <tr>
                        <th>Number</th>
                        <th>Name</th>
                        <th>K</th>
                        <th>Windowsize</th>
                        <th>Normalize</th>
                        <th>Retraininterval</th>
                    </tr>
                    </thead>
                    <tbody id="tableAlgoritmes"></tbody>
                </table>
            </div>
            <div class="metric_container__graph" id="arpuad_graph" ></div>

            <div class="container__algemeneinfo">
                <div class="container__algemeneinfo_split">
                    <div class="container__algemeneinfo_topkRecommendations" id="topkRecommendations">
                        <div class="topkRecommendation" id="tableRecommendations"></div>
                    </div>
                </div>
                <div class="container__algemeneinfo_split">
                    <div class="container__algemeneinfo_layer">
                        <div class="container__algemeneinfo_topkPurchases" id="topkPurchases">
                            <table class="generalPurpose_table flex-fixhead-topKPurchases_table" id="test2">
                                <thead>
                                <tr>
                                    <th>Item_id</th>
                                    <th>Count</th>
                                </tr>
                                </thead>
                                <tbody id="tableTopkRecommendations"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="container__algemeneinfo_layer">
                        <div class="container__algemeneinfo__values" id="uniqueUsers">
                            <h2>Unique users:</h2>
                            <p id="unique_users"></p>
                        </div>
                        <div class="container__algemeneinfo__values" id="totalRevenue">
                            <h2>Total revenue:</h2>
                            <p id="total_revenue"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="split__container">
            <div class="ab_container__info">
                <div class="metric__info_purch_active">
                    <h2>Total purchases:</h2>
                    <p id="purchases"></p>
                </div>
                <div class="metric__info_purch_active">
                    <h2>Active users:</h2>
                    <p id="users"></p>
                </div>
            </div>
            <div class="metric_container__graph" id="user_purch_graph"></div>
            <div class="metric_container__graph" id="ctr_arad_graph"></div>
            <div class="container__algemeneinfo">
                <div class="container__algemeneinfo_userlist" id="userLists">
                    <table class="generalPurpose_table flex-fixhead-userList_table" id="test3">
                        <thead>
                            <tr>
                                <th style="cursor: pointer" onclick="orderUsers(0)">Active user</th>
                                <th style="cursor: pointer" onclick="orderUsers(1)">Total purchases</th>
                                <th style="cursor: pointer" onclick="orderUsers(2)">Purchases over time</th>
                                <th style="cursor: pointer" onclick="orderUsers(3)">CTR</th>
                            </tr>
                        </thead>
                        <tbody id="tableUserList"></tbody>
                    </table>

                </div>
                <div class="container__algemeneinfo_slider">
                    <div class="slider__date">
                        <p>
                            <input type="text" id="amount" disabled style=" border: 0; color: #30799B; font-weight: bold; font-size: 18px" size="40" />
                        </p>
                    </div>

                    <div class="slider__range" id="slider-range"></div>
                    <div class="slider__button">
                        <div class="style_slider__button">
                            <button onclick="renewInterval()">RENEW</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<script>



    document.getElementById("abtest_id").innerHTML = "";
    document.getElementById("dataset_name").innerHTML = "";
    document.getElementById("startpoint").innerHTML = "";
    document.getElementById("stepsize").innerHTML = "";
    document.getElementById("topk").innerHTML = "";
    document.getElementById("endpoint").innerHTML = "";
    document.getElementById("purchases").innerHTML = "";
    document.getElementById("users").innerHTML = "";
    var interval = null;
    var requestInterval = null;
    let entered = false;
    let requestEntered = false;

    var topkPurchases = null
    var topkRecommendations = null
    var listUsers = null
    var sortedUserList = null
    var totaleRevenue = null
    var UniqueUsers = null
    var sortUsers = 0;
    var startPoint = null;
    var endPoint = null;
    var abtest = null;
    var dataset = null;

    function fetchStatus() {
        fetch(`/visualizations/update`)
            .then(function (response) {
                return response.text();
            })
            .then(function (text){
                let all = JSON.parse(text)
                if (Object.keys(all).length > 0 && entered == false){
                    entered = true;
                    let info = all["visualization"]

                    startPoint = info["startpoint"];
                    endPoint = info["endpoint"];

                    abtest = info["abtest_id"];
                    dataset = info["dataset_id"];

                    document.getElementById("abtest_id").innerHTML = abtest
                    document.getElementById("dataset_name").innerHTML = info["datasetname"];
                    document.getElementById("startpoint").innerHTML = startPoint
                    document.getElementById("stepsize").innerHTML = info["stepsize"]
                    document.getElementById("endpoint").innerHTML = endPoint
                    document.getElementById("topk").innerHTML = info["topk"];
                    document.getElementById("purchases").innerHTML = info["totalPurchases"];
                    document.getElementById("users").innerHTML = info["totalUsers"];
                    let dataUsersPurch = info["graphPurchAndUsers"]
                    let algorihtms = info["algorithms"]
                    let ctr = info["ctr"]
                    let arad = info["ar@d"]
                    let arpuad = info["arpu@d"]

                    google.charts.load('current', {packages: ['corechart', 'line']});
                    {#google.charts.setOnLoadCallback(drawActUsersAndPurchChart);#}
                    google.setOnLoadCallback(function () {
                        drawCTRandARAD(ctr, arad)
                        drawARPUAD(arpuad)
                        drawActUsersAndPurchChart(dataUsersPurch);
                    });
                    console.log("oke")
                    constructAlgorithmTable(algorihtms);

                    topkPurchases = all["topkPurchases"];
                    topkRecommendations = all["topkRecommendations"];
                    listUsers = all["listUsers"];
                    totaleRevenue = all["totaleRevenue"];
                    UniqueUsers = all["totaleUsers"];
                    sortedUserList = all["sortingOrder"]

                    constructTopkPurchases(topkPurchases);
                    constructTopkRecommendationsPerAlgo(topkRecommendations);
                    constructListActiveUsers()
                    document.getElementById("total_revenue").innerHTML = totaleRevenue;
                    document.getElementById("unique_users").innerHTML = UniqueUsers;
                    slider();
                    clearInterval(interval)
                }
            })
    }

    function slider() {
       $(function () {
        $("#slider-range").slider({
            range: true,
            min: new Date(startPoint).getTime() / 1000,
            max: new Date(endPoint).getTime() / 1000,
            step: 86400,
            values: [new Date(startPoint).getTime() / 1000, new Date(endPoint).getTime() / 1000],
            slide: function (event, ui) {
                $("#amount").val((new Date(ui.values[0] * 1000).toDateString()) + " - " + (new Date(ui.values[1] * 1000)).toDateString());
            }
        });
        $("#amount").val((new Date($("#slider-range").slider("values", 0) * 1000).toDateString()) +
            " - " + (new Date($("#slider-range").slider("values", 1) * 1000)).toDateString());
    });
    }

    function drawActUsersAndPurchChart(dataUsersPurch){
        var data = new google.visualization.DataTable();
        data.addColumn('date', 'X');
        data.addColumn('number', 'Purchases');
        data.addColumn('number', 'Active users');

        let dataGraph = []
        for (const [key, value] of Object.entries(dataUsersPurch)){
            dataGraph.push([new Date(key), parseInt(value["purchases"]), parseInt(value['users'])])
        }

        {#console.log(dataGraph)#}
        data.addRows(dataGraph);
        {#console.log(data)#}

        var options = {
        pointSize: 3,
        title: 'Purchases and active users per day.',
        chartArea: {
          width: '80%'
         },
        width: '100%',
        height: '100%',
        colors: ['#0032ff', '#b90000'],
        legend: { position: 'bottom' }
      };

      var chart = new google.visualization.LineChart(document.getElementById('user_purch_graph'));

      chart.draw(data, options);

    }

    function drawCTRandARAD(ctr, arad){
        var data = new google.visualization.DataTable();
        data.addColumn('date', 'X');

        {# Eerst de kollomen toevoegen #}
         let dates = []
         {#let data_ = []#}
         let count = 0
         for (const [key, value] of Object.entries(ctr)){
            data.addColumn('number', value["type"] + ": " + value["name"] + " — " + value["result_id"])

            if (count == 0){
                for (const [key2, value2] of Object.entries(value["values"])){
                    dates.push([new Date(key2)])
                    {#data_.push([])#}
                }
                count += 1
            }

        }
        for (const [key, value] of Object.entries(arad)){
            data.addColumn('number', value["type"] + ": " + value["name"] + " — " + value["result_id"])
        }

        {#console.log(dates)#}

        {#console.log(ctr)#}

        count = 0
        for (const [key, value] of Object.entries(ctr)){
            for (const [key2, value2] of Object.entries(value["values"])){
                {#console.log(value2)#}
                    dates[count].push(value2)
                    count += 1
            }
            count = 0
        }
        for (const [key, value] of Object.entries(arad)){
            for (const [key2, value2] of Object.entries(value["values"])){
                {#console.log(value2)#}
                    dates[count].push(value2)
                    count += 1
            }
            count = 0
        }

        {#console.log(dates)#}

        {#console.log(dataGraph)#}
        data.addRows(dates);
        {#console.log(data)#}

        var options = {
        pointSize: 3,
        title: 'CTR and ARAD',
        chartArea: {
          width: '80%'
         },
        width: '100%',
        height: '100%',
        colors: ['#9FE3FE', '#9CD0FE', '#9DBEFE', '#9CB5FE', '#9CB5FE', '#C2A5FF', '#D69DFF', '#DF9BFD', '#ED9BEB', '#F49CD3','#FEABB1', '#FECF9F', '#F7FCA8', '#D3FFA7', '#BEFEC4', '#BEFEC4'],
        legend: { position: 'bottom' }
      };

      var chart = new google.visualization.LineChart(document.getElementById('ctr_arad_graph'));

      chart.draw(data, options);

    }

    function drawARPUAD(dataarpuad){

        var data = new google.visualization.DataTable();
        data.addColumn('date', 'X');


        {# Eerst de kollomen toevoegen #}
         let dates = []
         {#let data_ = []#}
         let count = 0
         for (const [key, value] of Object.entries(dataarpuad)){
            data.addColumn('number', value["type"] + ": " + value["name"] + " — " + value["result_id"])

            if (count == 0){
                for (const [key2, value2] of Object.entries(value["values"])){
                    dates.push([new Date(key2)])
                    {#data_.push([])#}
                }
                count += 1
            }

        }

        {#console.log(dates)#}

        {#console.log(ctr)#}

        count = 0
        for (const [key, value] of Object.entries(dataarpuad)){
            for (const [key2, value2] of Object.entries(value["values"])){
                {#console.log(value2)#}
                    dates[count].push(value2)
                    count += 1
            }
            count = 0
        }

        {#console.log(dates)#}

        {#console.log(dataGraph)#}
        data.addRows(dates);
        {#console.log(data)#}

        var options = {
        pointSize: 3,
        title: 'ARPU@D',
        chartArea: {
          width: '80%'
         },
        width: '100%',
        height: '100%',
        colors: ['#9FE3FE', '#9CD0FE', '#9DBEFE', '#9CB5FE', '#9CB5FE', '#C2A5FF', '#D69DFF', '#DF9BFD', '#ED9BEB', '#F49CD3','#FEABB1', '#FECF9F', '#F7FCA8', '#D3FFA7', '#BEFEC4', '#BEFEC4'],
        legend: { position: 'bottom' }
      };

      var chart = new google.visualization.LineChart(document.getElementById('arpuad_graph'));

      chart.draw(data, options);

    }

    function constructAlgorithmTable(dataAlgo){
        html_ = ""
        for (const [key, value] of Object.entries(dataAlgo)){

            html_ += "<tr>"

            let params = value["params"]


            html_ += "<td data-label=\"Number\">"+ value["result_id"] +"</td>"
            html_ += "<td data-label=\"Name\">"+ value["name"] +"</td>"

            if (params.hasOwnProperty("k")){
                html_ += "<td data-label=\"K\">"+ params["k"] +"</td>"
            }
            else {
                html_ += "<td data-label=\"K\">/</td>"
            }
            if (params.hasOwnProperty("windowsize")){
                html_ += "<td data-label=\"Windowsize\">"+ params["windowsize"] +"</td>"
            }

            else if (params.hasOwnProperty("window")){
                html_ += "<td data-label=\"Windowsize\">"+ params["window"] +"</td>"
            }
            else {
                html_ += "<td data-label=\"Windowsize\">/</td>"
            }

            if (params.hasOwnProperty("normalize")){
                html_ += "<td data-label=\"Normalize\">"+ params["normalize"] +"</td>"
            }
            else {
                html_ += "<td data-label=\"Normalize\">/</td>"
            }
            if (params.hasOwnProperty("retraininterval")){
                html_ += "<td data-label=\"Retraininterval\">"+ params["retraininterval"] +"</td>"
            }
            else {
                html_ += "<td data-label=\"Retraininterval\">/</td>"
            }

            html_ += "</tr>"

        }
        document.getElementById("tableAlgoritmes").innerHTML = html_
    }

    function constructTopkPurchases(dataPurchases){
        html_ = ""
        for (const [key, value] of Object.entries(dataPurchases)){

            html_ += "<tr>"
            html_ += "<td data-label=\"Item-id\">"+ value["item"] +"</td>"
            html_ += "<td data-label=\"Count\">"+ value["count"] +"</td>"
            html_ += "</tr>"

        }
        document.getElementById("tableTopkRecommendations").innerHTML = html_
    }

    function constructTopkRecommendationsPerAlgo(dataRecommendations) {
       html_ = ""
        for (const [key, value] of Object.entries(dataRecommendations)){
            html_ += "<div class=\"topkRecommendationHead\">"
            html_ += "    <h2>" + value["name"] + "</h2>"
            html_ += "    <p>Algorithm number: " +  key.toString() + "</p>"
            html_ += "</div>"

            html_ += "<div class=\"topkRecommendationContent\">"

            for (const recommendation of value["recommendations"]) {

               html_ += "<div class=\"topkRecommendationRow\">"
               html_ += "     <div class=\"topkRecommendationColumn\">" + recommendation["item"] + "</div>"
               html_ += "     <div class=\"topkRecommendationColumn\">" + recommendation["count"] + "</div>"
               html_ += "</div>"

            }

            html_ += "</div>"

        }
        document.getElementById("tableRecommendations").innerHTML = html_
    }

    function constructListActiveUsers(){
       html_ = ""

        let rowCount = 0;

        for (const id of sortedUserList[sortUsers]){
            html_ += "<tr>"
            html_ += "<td data-label=\"Active user\">"+ id +"</td>"
            html_ += "<td data-label=\"Total purchases\">"+ listUsers[id]["totalePurchases"] +"</td>"
            html_ += "<td data-label=\"Purchases over time-period\">"+ listUsers[id]["purchasesOverTime"] +"</td>"
            html_ += "<td data-label=\"CTR\">"+ listUsers[id]["CTR"] +"</td>"
            html_ += "</tr>"

            if (rowCount == 1000){
                break;
            }
            rowCount += 1;
        }
        document.getElementById("tableUserList").innerHTML = html_
    }

    function orderUsers(number) {
        sortUsers = number;
        constructListActiveUsers();
    }

    function fetchRequest() {
               fetch(`/visualizations/updateRequest`)
            .then(function (response) {
                return response.text();
            })
            .then(function (text){
                let all = JSON.parse(text)
                if (Object.keys(all).length > 0 && requestEntered == false){
                    requestEntered = true;

                    topkPurchases = all["topkPurchases"];
                    topkRecommendations = all["topkRecommendations"];
                    listUsers = all["listUsers"];
                    totaleRevenue = all["totaleRevenue"];
                    UniqueUsers = all["totaleUsers"];
                    sortedUserList = all["sortingOrder"]

                    constructTopkPurchases(topkPurchases);
                    constructTopkRecommendationsPerAlgo(topkRecommendations);
                    constructListActiveUsers()
                    document.getElementById("total_revenue").innerHTML = totaleRevenue;
                    document.getElementById("unique_users").innerHTML = UniqueUsers;
                    clearInterval(requestInterval);
                }
            })

    }

    function renewInterval() {

        let start = (new Date($("#slider-range").slider("values", 0) * 1000)).toISOString().slice(0, 10);
        let end = (new Date($("#slider-range").slider("values", 1) * 1000)).toISOString().slice(0, 10);

        let data_dict = {"startdate": start, "enddate": end, "abtest_id": abtest, "dataset_id": dataset};

        $.ajax({
            type: 'POST',
            url: '/visualizations/request',
            data: JSON.stringify(data_dict),
            contentType: 'application/json; charset=utf-8',
            cache: false,
            processData: false,
            success: function(data) {
                console.log(data);
                requestInterval = setInterval(fetchRequest, 1000)
                requestEntered = false;
            },
        });

    }

    {#function getRowValue(value){#}
    {##}
    {# } #}

    window.addEventListener('load', function () {
        let fetchInterval = 1000;
        interval = setInterval(fetchStatus, fetchInterval)
    })

</script>

</html>




